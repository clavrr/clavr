# Performance & Load Testing
name: Performance Tests

on:
  schedule:
    # Run performance tests weekly on Saturdays
    - cron: '0 3 * * 6'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'api/**'

env:
  PYTHON_VERSION: '3.9'

jobs:
  # Job 1: API Performance Tests
  api-performance:
    name: API Performance Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install locust pytest-benchmark
        pip install -r requirements.txt
    
    - name: Run benchmark tests
      run: |
        pytest tests/ -v --benchmark-only --benchmark-json=benchmark.json
      continue-on-error: true
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: benchmark.json
        retention-days: 90

  # Job 2: Database Performance
  database-performance:
    name: Database Performance Testing
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: notely_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: notely_perf
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run database performance tests
      env:
        DATABASE_URL: postgresql://notely_test:test_password@localhost:5432/notely_perf
      run: |
        echo "Running database performance tests..."
        # Add database performance test script here
        python -c "
        from src.database import init_db, get_session
        import time
        
        # Initialize database
        init_db()
        
        # Test query performance
        with get_session() as session:
            start = time.time()
            # Add performance test queries
            end = time.time()
            print(f'Query execution time: {end - start:.4f}s')
        "
      continue-on-error: true

  # Job 3: Memory Profiling
  memory-profiling:
    name: Memory Usage Profiling
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install memory-profiler psutil
        pip install -r requirements.txt
    
    - name: Run memory profiling
      run: |
        python -m memory_profiler -h || echo "Memory profiler check"
        # Add memory profiling script
      continue-on-error: true

  # Job 4: Performance Report
  performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [api-performance, database-performance, memory-profiling]
    if: always()
    
    steps:
    - name: Create performance summary
      run: |
        echo "## Performance Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| API Performance | ${{ needs.api-performance.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Database Performance | ${{ needs.database-performance.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Memory Profiling | ${{ needs.memory-profiling.result }} |" >> $GITHUB_STEP_SUMMARY
